<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DGG Polls — Dashboard</title>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #0a0a0c;
      --surface: #111114;
      --border: #1e1e24;
      --border-light: #2a2a32;
      --text: #e4e4e8;
      --text-dim: #7a7a86;
      --text-muted: #52525c;
      --accent: #6e6eff;
      --accent-dim: rgba(110, 110, 255, 0.12);
      --green: #34d399;
      --green-dim: rgba(52, 211, 153, 0.12);
      --amber: #fbbf24;
      --amber-dim: rgba(251, 191, 36, 0.12);
      --rose: #f87171;
      --rose-dim: rgba(248, 113, 113, 0.12);
      --cyan: #22d3ee;
      --cyan-dim: rgba(34, 211, 238, 0.12);
      --radius: 10px;
      --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      --mono: 'JetBrains Mono', 'SF Mono', 'Fira Code', monospace;
    }

    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 48px 24px;
    }

    /* Header */
    .header {
      margin-bottom: 48px;
    }
    .header h1 {
      font-size: 28px;
      font-weight: 600;
      letter-spacing: -0.5px;
      margin-bottom: 6px;
    }
    .header p {
      color: var(--text-dim);
      font-size: 14px;
      font-weight: 400;
    }

    /* Metric Cards */
    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1px;
      background: var(--border);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      margin-bottom: 32px;
    }
    .metric {
      background: var(--surface);
      padding: 24px;
    }
    .metric-label {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin-bottom: 8px;
    }
    .metric-value {
      font-size: 28px;
      font-weight: 600;
      letter-spacing: -0.5px;
      font-family: var(--mono);
    }
    .metric-sub {
      font-size: 12px;
      color: var(--text-dim);
      margin-top: 4px;
    }

    /* Grid */
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }
    .grid-full {
      margin-bottom: 24px;
    }

    @media (max-width: 768px) {
      .grid-2 { grid-template-columns: 1fr; }
    }

    /* Card */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }
    .card-header {
      padding: 20px 24px 16px;
      display: flex;
      align-items: baseline;
      justify-content: space-between;
    }
    .card-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
    }
    .card-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }
    .card-body {
      padding: 0 24px 24px;
    }

    /* Charts */
    .chart-container {
      position: relative;
      width: 100%;
    }
    .chart-container svg {
      width: 100%;
      height: auto;
      display: block;
    }

    /* Bar chart */
    .bar-chart {
      display: flex;
      align-items: flex-end;
      gap: 2px;
      height: 160px;
      padding-top: 8px;
    }
    .bar-col {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100%;
      justify-content: flex-end;
    }
    .bar {
      width: 100%;
      border-radius: 3px 3px 0 0;
      transition: opacity 0.2s;
      min-height: 2px;
    }
    .bar:hover {
      opacity: 0.8;
    }
    .bar-label {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 8px;
      font-family: var(--mono);
    }

    /* Hourly heatmap */
    .heatmap {
      display: grid;
      grid-template-columns: repeat(24, 1fr);
      gap: 3px;
    }
    .heat-cell {
      aspect-ratio: 1;
      border-radius: 3px;
      position: relative;
    }
    .heat-cell:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: calc(100% + 6px);
      left: 50%;
      transform: translateX(-50%);
      background: #222;
      color: var(--text);
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 4px;
      white-space: nowrap;
      font-family: var(--mono);
      z-index: 10;
      pointer-events: none;
    }
    .heat-labels {
      display: grid;
      grid-template-columns: repeat(24, 1fr);
      gap: 3px;
      margin-top: 6px;
    }
    .heat-label {
      font-size: 9px;
      color: var(--text-muted);
      text-align: center;
      font-family: var(--mono);
    }

    /* Day of week */
    .dow-chart {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .dow-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .dow-label {
      width: 36px;
      font-size: 12px;
      color: var(--text-dim);
      font-family: var(--mono);
      text-align: right;
      flex-shrink: 0;
    }
    .dow-bar-track {
      flex: 1;
      height: 24px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }
    .dow-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.6s ease;
    }
    .dow-value {
      width: 48px;
      font-size: 12px;
      color: var(--text-dim);
      font-family: var(--mono);
      text-align: right;
      flex-shrink: 0;
    }

    /* Table */
    .table-wrap {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    thead th {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.6px;
      text-align: left;
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
    }
    thead th:last-child,
    tbody td:last-child {
      text-align: right;
    }
    tbody td {
      font-size: 13px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      color: var(--text-dim);
    }
    tbody tr:last-child td {
      border-bottom: none;
    }
    tbody tr:hover td {
      background: rgba(255,255,255, 0.02);
    }
    .rank {
      font-family: var(--mono);
      color: var(--text-muted);
      font-size: 12px;
    }
    .creator-name {
      color: var(--text);
      font-weight: 500;
    }
    .poll-q {
      color: var(--text);
      font-weight: 400;
      max-width: 460px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    tbody tr.poll-row {
      cursor: pointer;
    }
    tbody tr.poll-row:hover td:first-child::before {
      content: '';
    }
    tr.poll-detail-row td {
      padding: 0 !important;
      border-bottom: 1px solid var(--border);
    }
    tr.poll-detail-row:last-child td {
      border-bottom: none;
    }
    .poll-detail {
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.3s ease, padding 0.3s ease;
      padding: 0 16px;
    }
    .poll-detail.open {
      max-height: 500px;
      padding: 12px 16px 16px;
    }
    .poll-detail-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .poll-option-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .poll-option-label {
      width: 140px;
      font-size: 12px;
      color: var(--text-dim);
      flex-shrink: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .poll-option-bar-track {
      flex: 1;
      height: 20px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }
    .poll-option-bar-fill {
      height: 100%;
      border-radius: 4px;
      background: var(--accent);
      transition: width 0.5s ease;
    }
    .poll-option-bar-fill.winner {
      background: var(--green);
    }
    .poll-option-value {
      width: 72px;
      font-size: 12px;
      color: var(--text-dim);
      font-family: var(--mono);
      text-align: right;
      flex-shrink: 0;
    }
    .mono {
      font-family: var(--mono);
      font-size: 13px;
    }

    /* Sparkline area chart */
    .area-chart {
      position: relative;
    }
    .area-chart svg {
      display: block;
    }
    .chart-grid-line {
      stroke: var(--border);
      stroke-width: 0.5;
    }
    .chart-label {
      fill: var(--text-muted);
      font-size: 10px;
      font-family: var(--mono);
    }
    .chart-line {
      fill: none;
      stroke-width: 1.5;
    }
    .chart-area {
      opacity: 0.08;
    }
    .chart-dot {
      r: 2.5;
      opacity: 0;
      transition: opacity 0.15s;
    }
    .chart-dot:hover {
      opacity: 1;
    }

    /* Tag / badge */
    .badge {
      display: inline-block;
      font-size: 11px;
      font-weight: 500;
      padding: 2px 8px;
      border-radius: 100px;
      font-family: var(--mono);
    }
    .badge-accent { background: var(--accent-dim); color: var(--accent); }
    .badge-green { background: var(--green-dim); color: var(--green); }

    /* Year timeline */
    .timeline {
      display: flex;
      gap: 1px;
      background: var(--border);
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 24px;
    }
    .timeline-segment {
      padding: 16px 20px;
      background: var(--surface);
      flex: 1;
      text-align: center;
    }
    .timeline-year {
      font-size: 12px;
      color: var(--text-muted);
      font-family: var(--mono);
      margin-bottom: 4px;
    }
    .timeline-count {
      font-size: 20px;
      font-weight: 600;
      font-family: var(--mono);
    }
    .timeline-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    /* Monthly chart x-labels */
    .month-labels {
      display: flex;
      justify-content: space-between;
      padding: 6px 0 0;
    }
    .month-label-item {
      font-size: 10px;
      color: var(--text-muted);
      font-family: var(--mono);
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- Header -->
    <div class="header">
      <h1>DGG Poll Analytics</h1>
      <p id="header-sub">Loading poll data…</p>
    </div>

    <!-- Key Metrics -->
    <div class="metrics">
      <div class="metric">
        <div class="metric-label">Total Polls</div>
        <div class="metric-value">—</div>
        <div class="metric-sub">Loading…</div>
      </div>
      <div class="metric">
        <div class="metric-label">Total Votes</div>
        <div class="metric-value">—</div>
        <div class="metric-sub">Across all polls</div>
      </div>
      <div class="metric">
        <div class="metric-label">Avg Votes / Poll</div>
        <div class="metric-value">—</div>
        <div class="metric-sub">Median participation</div>
      </div>
      <div class="metric">
        <div class="metric-label">Peak Votes</div>
        <div class="metric-value">—</div>
        <div class="metric-sub">Single poll record</div>
      </div>
      <div class="metric">
        <div class="metric-label">Unique Creators</div>
        <div class="metric-value" id="unique-creators">—</div>
        <div class="metric-sub">Poll organizers</div>
      </div>
    </div>

    <!-- Year breakdown -->
    <div class="timeline">
    </div>

    <!-- Monthly Charts -->
    <div class="grid-full">
      <div class="card">
        <div class="card-header">
          <span class="card-title">Monthly Poll Volume</span>
          <span class="card-subtitle">Polls created per month</span>
        </div>
        <div class="card-body">
          <div class="bar-chart" id="monthly-chart"></div>
          <div class="month-labels" id="monthly-labels"></div>
        </div>
      </div>
    </div>

    <!-- Avg Votes Trend + Hourly Activity -->
    <div class="grid-2">
      <div class="card">
        <div class="card-header">
          <span class="card-title">Avg Votes per Poll</span>
          <span class="card-subtitle">Monthly trend</span>
        </div>
        <div class="card-body">
          <div class="area-chart" id="avg-chart"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <span class="card-title">Activity by Hour (UTC)</span>
          <span class="card-subtitle">Poll creation time distribution</span>
        </div>
        <div class="card-body">
          <div class="bar-chart" id="hourly-chart" style="height:120px;"></div>
          <div class="heat-labels">
            <span class="heat-label">0</span><span class="heat-label"></span>
            <span class="heat-label">2</span><span class="heat-label"></span>
            <span class="heat-label">4</span><span class="heat-label"></span>
            <span class="heat-label">6</span><span class="heat-label"></span>
            <span class="heat-label">8</span><span class="heat-label"></span>
            <span class="heat-label">10</span><span class="heat-label"></span>
            <span class="heat-label">12</span><span class="heat-label"></span>
            <span class="heat-label">14</span><span class="heat-label"></span>
            <span class="heat-label">16</span><span class="heat-label"></span>
            <span class="heat-label">18</span><span class="heat-label"></span>
            <span class="heat-label">20</span><span class="heat-label"></span>
            <span class="heat-label">22</span><span class="heat-label"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Day of Week + Option Distribution -->
    <div class="grid-2">
      <div class="card">
        <div class="card-header">
          <span class="card-title">Day of Week</span>
          <span class="card-subtitle">Poll creation frequency</span>
        </div>
        <div class="card-body">
          <div class="dow-chart" id="dow-chart"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <span class="card-title">Options per Poll</span>
          <span class="card-subtitle">Distribution of answer choices</span>
        </div>
        <div class="card-body">
          <div class="dow-chart" id="options-chart"></div>
        </div>
      </div>
    </div>

    <!-- Top Creators -->
    <div class="grid-full">
      <div class="card">
        <div class="card-header">
          <span class="card-title">Top Poll Creators</span>
          <span class="card-subtitle">By number of polls created</span>
        </div>
        <div class="card-body" style="padding:0;">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th style="width:40px">#</th>
                  <th>Creator</th>
                  <th>Polls</th>
                  <th>Total Votes</th>
                  <th>Avg Votes</th>
                </tr>
              </thead>
              <tbody id="creators-table"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Top Polls -->
    <div class="grid-full">
      <div class="card">
        <div class="card-header">
          <span class="card-title">Most Voted Polls</span>
          <span class="card-subtitle">All-time highest participation</span>
        </div>
        <div class="card-body" style="padding:0;">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th style="width:40px">#</th>
                  <th>Question</th>
                  <th>Creator</th>
                  <th>Date</th>
                  <th>Votes</th>
                </tr>
              </thead>
              <tbody id="polls-table"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div style="text-align:center; margin-top:48px; padding-top:24px; border-top:1px solid var(--border);">
      <p style="font-size:12px; color:var(--text-muted);">
        Data sourced from <a href="https://api.mitchdev.net/dgg/polls" style="color:var(--text-muted)">api.mitchdev.net</a> &middot; <span id="footer-count">—</span> polls &middot; Live data
      </p>
    </div>

  </div>

  <script>
    // ── Helpers ──────────────────────────────────────────
    const fmt = (n) => n.toLocaleString('en-US');
    const pct = (v, max) => ((v / max) * 100).toFixed(1);
    const escHtml = (s) => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

    // ── Aggregate raw poll data ─────────────────────────
    function aggregate(data) {
      const totalPolls = data.length;
      const totalVotes = data.reduce((s, p) => s + p.totalVotes, 0);
      const avgVotes = totalPolls ? (totalVotes / totalPolls) : 0;
      const peakVotes = Math.max(...data.map(p => p.totalVotes));
      const uniqueCreators = new Set(data.map(p => p.startedBy)).size;

      // Date range
      const dates = data.map(p => new Date(p.startTime));
      const minDate = new Date(Math.min(...dates));
      const maxDate = new Date(Math.max(...dates));

      // Year breakdown
      const yearMap = {};
      data.forEach(p => {
        const y = new Date(p.startTime).getFullYear();
        yearMap[y] = (yearMap[y] || 0) + 1;
      });
      const years = Object.keys(yearMap).sort().map(y => ({ year: +y, count: yearMap[y] }));

      // Monthly data
      const monthMap = {};
      data.forEach(p => {
        const d = new Date(p.startTime);
        const m = `${d.getUTCFullYear()}-${String(d.getUTCMonth() + 1).padStart(2, '0')}`;
        if (!monthMap[m]) monthMap[m] = { count: 0, votes: 0 };
        monthMap[m].count++;
        monthMap[m].votes += p.totalVotes;
      });
      const monthlyData = Object.keys(monthMap).sort().map(m => ({ m, count: monthMap[m].count, votes: monthMap[m].votes }));

      // Hourly data
      const hourlyData = new Array(24).fill(0);
      data.forEach(p => { hourlyData[new Date(p.startTime).getUTCHours()]++; });

      // Day of week data
      const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      const dowCounts = new Array(7).fill(0);
      data.forEach(p => { dowCounts[new Date(p.startTime).getUTCDay()]++; });
      // Reorder to Mon-Sun
      const dowData = [1,2,3,4,5,6,0].map(i => ({ day: dayNames[i], count: dowCounts[i] }));

      // Options distribution
      const optCounts = {};
      data.forEach(p => {
        const n = p.options.length;
        const key = n >= 5 ? '5+' : String(n);
        optCounts[key] = (optCounts[key] || 0) + 1;
      });
      const optLabels = ['1', '2', '3', '4', '5+'];
      const optionsData = optLabels
        .filter(k => optCounts[k])
        .map(k => ({ label: k === '1' ? '1 opt' : `${k} opts`, count: optCounts[k] }));

      // Top creators (top 15 by poll count)
      const creatorMap = {};
      data.forEach(p => {
        if (!creatorMap[p.startedBy]) creatorMap[p.startedBy] = { polls: 0, votes: 0 };
        creatorMap[p.startedBy].polls++;
        creatorMap[p.startedBy].votes += p.totalVotes;
      });
      const creatorsData = Object.entries(creatorMap)
        .map(([name, d]) => ({ name, polls: d.polls, votes: d.votes }))
        .sort((a, b) => b.polls - a.polls)
        .slice(0, 15);

      // Top polls (top 15 by votes)
      const topPolls = [...data]
        .sort((a, b) => b.totalVotes - a.totalVotes)
        .slice(0, 15)
        .map(p => ({
          votes: p.totalVotes,
          creator: p.startedBy,
          date: p.startTime.slice(0, 10),
          q: p.question,
          options: p.options,
          optionVotes: p.votes,
        }));

      return { totalPolls, totalVotes, avgVotes, peakVotes, uniqueCreators, minDate, maxDate, years, monthlyData, hourlyData, dowData, optionsData, creatorsData, topPolls };
    }

    // ── Render functions ─────────────────────────────────

    function renderMetrics({ totalPolls, totalVotes, avgVotes, peakVotes, uniqueCreators, minDate }) {
      const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      const since = `Since ${monthNames[minDate.getUTCMonth()]} ${minDate.getUTCFullYear()}`;
      document.querySelector('.metric:nth-child(1) .metric-value').textContent = fmt(totalPolls);
      document.querySelector('.metric:nth-child(1) .metric-sub').textContent = since;
      document.querySelector('.metric:nth-child(2) .metric-value').textContent = fmt(totalVotes);
      document.querySelector('.metric:nth-child(3) .metric-value').textContent = avgVotes.toFixed(1);
      document.querySelector('.metric:nth-child(4) .metric-value').textContent = fmt(peakVotes);
      document.getElementById('unique-creators').textContent = fmt(uniqueCreators);
    }

    function renderHeader({ totalPolls, minDate, maxDate }) {
      const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      const from = `${monthNames[minDate.getUTCMonth()]} ${minDate.getUTCFullYear()}`;
      const to = `${monthNames[maxDate.getUTCMonth()]} ${maxDate.getUTCFullYear()}`;
      document.getElementById('header-sub').textContent = `${fmt(totalPolls)} polls tracked from ${from} to ${to}`;
    }

    function renderYears(years, currentYear) {
      const el = document.querySelector('.timeline');
      el.innerHTML = '';
      years.forEach(y => {
        const seg = document.createElement('div');
        seg.className = 'timeline-segment';
        const label = y.year === currentYear ? 'polls (YTD)' : 'polls';
        seg.innerHTML = `
          <div class="timeline-year">${y.year}</div>
          <div class="timeline-count">${fmt(y.count)}</div>
          <div class="timeline-label">${label}</div>
        `;
        el.appendChild(seg);
      });
    }

    function renderMonthlyChart(monthlyData) {
      const el = document.getElementById('monthly-chart');
      const labels = document.getElementById('monthly-labels');
      el.innerHTML = '';
      labels.innerHTML = '';
      const max = Math.max(...monthlyData.map(d => d.count));

      monthlyData.forEach(d => {
        const col = document.createElement('div');
        col.className = 'bar-col';
        const bar = document.createElement('div');
        bar.className = 'bar';
        bar.style.height = ((d.count / max) * 100) + '%';
        bar.style.background = 'var(--accent)';
        bar.title = `${d.m}: ${fmt(d.count)} polls, ${fmt(d.votes)} votes`;
        col.appendChild(bar);
        el.appendChild(col);
      });

      const showLabels = [0, 6, 12, 18, 24, 30, monthlyData.length - 1];
      const seen = new Set();
      showLabels.forEach(idx => {
        if (idx < monthlyData.length && !seen.has(idx)) {
          seen.add(idx);
          const sp = document.createElement('span');
          sp.className = 'month-label-item';
          sp.textContent = monthlyData[idx].m.replace('20', "'");
          labels.appendChild(sp);
        }
      });
    }

    function renderAvgChart(monthlyData) {
      const el = document.getElementById('avg-chart');
      const data = monthlyData.map(d => d.votes / d.count);
      const w = 520, h = 160, pad = { t: 10, r: 10, b: 24, l: 40 };
      const cw = w - pad.l - pad.r;
      const ch = h - pad.t - pad.b;
      const max = Math.max(...data);
      const min = Math.min(...data);
      const range = max - min || 1;

      const x = (i) => pad.l + (i / (data.length - 1)) * cw;
      const y = (v) => pad.t + ch - ((v - min) / range) * ch;

      let pathD = data.map((v, i) => `${i === 0 ? 'M' : 'L'}${x(i).toFixed(1)},${y(v).toFixed(1)}`).join(' ');
      let areaD = pathD + ` L${x(data.length - 1).toFixed(1)},${(pad.t + ch).toFixed(1)} L${x(0).toFixed(1)},${(pad.t + ch).toFixed(1)} Z`;

      let svg = `<svg viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">`;
      const gridSteps = 4;
      for (let i = 0; i <= gridSteps; i++) {
        const gy = pad.t + (i / gridSteps) * ch;
        const val = max - (i / gridSteps) * range;
        svg += `<line x1="${pad.l}" y1="${gy}" x2="${w - pad.r}" y2="${gy}" class="chart-grid-line"/>`;
        svg += `<text x="${pad.l - 6}" y="${gy + 3}" text-anchor="end" class="chart-label">${Math.round(val)}</text>`;
      }
      svg += `<path d="${areaD}" fill="var(--accent)" class="chart-area"/>`;
      svg += `<path d="${pathD}" stroke="var(--accent)" class="chart-line"/>`;
      data.forEach((v, i) => {
        svg += `<circle cx="${x(i).toFixed(1)}" cy="${y(v).toFixed(1)}" class="chart-dot" fill="var(--accent)">
          <title>${monthlyData[i].m}: ${v.toFixed(1)} avg votes</title>
        </circle>`;
      });
      const labelIdx = [0, Math.floor(data.length / 3), Math.floor(2 * data.length / 3), data.length - 1];
      labelIdx.forEach(i => {
        svg += `<text x="${x(i).toFixed(1)}" y="${h - 2}" text-anchor="middle" class="chart-label">${monthlyData[i].m.replace('20', "'")}</text>`;
      });
      svg += '</svg>';
      el.innerHTML = svg;
    }

    function renderHourlyChart(hourlyData) {
      const el = document.getElementById('hourly-chart');
      el.innerHTML = '';
      const max = Math.max(...hourlyData);
      hourlyData.forEach((v, i) => {
        const col = document.createElement('div');
        col.className = 'bar-col';
        const bar = document.createElement('div');
        bar.className = 'bar';
        bar.style.height = ((v / max) * 100) + '%';
        const intensity = v / max;
        if (intensity > 0.7) bar.style.background = 'var(--cyan)';
        else if (intensity > 0.4) bar.style.background = 'rgba(34, 211, 238, 0.6)';
        else bar.style.background = 'rgba(34, 211, 238, 0.25)';
        bar.title = `${String(i).padStart(2,'0')}:00 UTC — ${fmt(v)} polls`;
        col.appendChild(bar);
        el.appendChild(col);
      });
    }

    function renderDowChart(dowData) {
      const el = document.getElementById('dow-chart');
      el.innerHTML = '';
      const max = Math.max(...dowData.map(d => d.count));
      dowData.forEach(d => {
        const row = document.createElement('div');
        row.className = 'dow-row';
        row.innerHTML = `
          <span class="dow-label">${d.day}</span>
          <div class="dow-bar-track">
            <div class="dow-bar-fill" style="width:${pct(d.count, max)}%;background:var(--green);"></div>
          </div>
          <span class="dow-value">${fmt(d.count)}</span>
        `;
        el.appendChild(row);
      });
    }

    function renderOptionsChart(optionsData) {
      const el = document.getElementById('options-chart');
      el.innerHTML = '';
      const max = Math.max(...optionsData.map(d => d.count));
      optionsData.forEach(d => {
        const row = document.createElement('div');
        row.className = 'dow-row';
        row.innerHTML = `
          <span class="dow-label" style="width:48px">${d.label}</span>
          <div class="dow-bar-track">
            <div class="dow-bar-fill" style="width:${pct(d.count, max)}%;background:var(--amber);"></div>
          </div>
          <span class="dow-value">${fmt(d.count)}</span>
        `;
        el.appendChild(row);
      });
    }

    function renderCreatorsTable(creatorsData) {
      const el = document.getElementById('creators-table');
      el.innerHTML = '';
      creatorsData.forEach((c, i) => {
        const avg = (c.votes / c.polls).toFixed(1);
        el.innerHTML += `<tr>
          <td class="rank">${i + 1}</td>
          <td class="creator-name">${escHtml(c.name)}</td>
          <td class="mono">${fmt(c.polls)}</td>
          <td class="mono">${fmt(c.votes)}</td>
          <td class="mono">${avg}</td>
        </tr>`;
      });
    }

    function renderTopPolls(topPolls) {
      const el = document.getElementById('polls-table');
      el.innerHTML = '';
      topPolls.forEach((p, i) => {
        const maxOptVotes = Math.max(...p.optionVotes);
        const winnerIdx = p.optionVotes.indexOf(maxOptVotes);
        let optionsHtml = '';
        p.options.forEach((opt, j) => {
          const v = p.optionVotes[j];
          const barPct = maxOptVotes > 0 ? ((v / maxOptVotes) * 100).toFixed(1) : 0;
          const votePct = p.votes > 0 ? ((v / p.votes) * 100).toFixed(1) : 0;
          const isWinner = j === winnerIdx && maxOptVotes > 0;
          optionsHtml += `<div class="poll-option-row">
            <span class="poll-option-label" title="${escHtml(opt)}">${escHtml(opt)}</span>
            <div class="poll-option-bar-track">
              <div class="poll-option-bar-fill${isWinner ? ' winner' : ''}" style="width:${barPct}%"></div>
            </div>
            <span class="poll-option-value">${fmt(v)} (${votePct}%)</span>
          </div>`;
        });
        el.innerHTML += `<tr class="poll-row" data-poll-idx="${i}">
          <td class="rank">${i + 1}</td>
          <td class="poll-q" title="${escHtml(p.q)}">${escHtml(p.q)}</td>
          <td style="color:var(--text-dim)">${escHtml(p.creator)}</td>
          <td class="mono" style="color:var(--text-muted)">${p.date}</td>
          <td class="mono" style="color:var(--text)"><strong>${fmt(p.votes)}</strong></td>
        </tr>
        <tr class="poll-detail-row" data-poll-idx="${i}">
          <td colspan="5">
            <div class="poll-detail" id="poll-detail-${i}">
              <div class="poll-detail-options">${optionsHtml}</div>
            </div>
          </td>
        </tr>`;
      });

      el.querySelectorAll('.poll-row').forEach(row => {
        row.addEventListener('click', () => {
          const idx = row.getAttribute('data-poll-idx');
          const detail = document.getElementById('poll-detail-' + idx);
          detail.classList.toggle('open');
        });
      });
    }

    function renderFooter(totalPolls) {
      document.getElementById('footer-count').textContent = fmt(totalPolls);
    }

    // ── Cache helpers (localStorage, 1 hour TTL) ────────
    const CACHE_KEY = 'dgg-polls-data';
    const CACHE_TTL = 60 * 60 * 1000; // 1 hour

    function getCached() {
      try {
        const raw = localStorage.getItem(CACHE_KEY);
        if (!raw) return null;
        const { ts, data } = JSON.parse(raw);
        if (Date.now() - ts > CACHE_TTL) return null;
        return data;
      } catch { return null; }
    }

    function setCache(data) {
      try {
        localStorage.setItem(CACHE_KEY, JSON.stringify({ ts: Date.now(), data }));
      } catch { /* storage full or unavailable */ }
    }

    // ── Fetch and render ─────────────────────────────────
    const cached = getCached();
    (cached ? Promise.resolve(cached) :
      fetch('https://api.mitchdev.net/dgg/polls')
        .then(r => {
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          return r.json();
        })
        .then(data => { setCache(data); return data; })
    ).then(data => {
        const stats = aggregate(data);
        const currentYear = new Date().getFullYear();

        renderHeader(stats);
        renderMetrics(stats);
        renderYears(stats.years, currentYear);
        renderMonthlyChart(stats.monthlyData);
        renderAvgChart(stats.monthlyData);
        renderHourlyChart(stats.hourlyData);
        renderDowChart(stats.dowData);
        renderOptionsChart(stats.optionsData);
        renderCreatorsTable(stats.creatorsData);
        renderTopPolls(stats.topPolls);
        renderFooter(stats.totalPolls);
      })
      .catch(err => {
        console.error('Failed to load poll data:', err);
        document.getElementById('header-sub').textContent = 'Failed to load poll data. Please try refreshing.';
      });
  </script>
</body>
</html>
